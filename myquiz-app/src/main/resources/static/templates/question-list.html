<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="ISO-8859-1">
    <title>Author questions</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/styles.css}">
</head>
<body>

<div th:insert="~{fragments::menu}"></div>
<div style="clear:both; margin-bottom:20px;"></div>

<h4>Quiz:
    <span th:if="${quiz != null}" th:text="${quiz.name + ' / ' + quiz.course + ' / ' + quiz.questionsMC.size() + ' MC / ' + quiz.questionsTF.size() + ' TF'}"></span>
    <span th:if="${quiz == null}">No quiz selected</span>
</h4>
<h4>Questions and errors for the author:
    <form id="authorFilterForm" method="get" th:action="@{/questions}">
        <select id="authorFilter" name="author" onchange="document.getElementById('authorFilterForm').submit()">
            <option value="">All Authors</option>
            <option th:each="author : ${authors}" th:value="${author.id}" th:text="${author.name}" th:selected="${author.id} == ${selectedAuthorId}"></option>
        </select>
    </form>
</h4>
<div th:each="quiz : ${quizzes}">
    <span th:text="${quiz.name + ' / ' + quiz.course + ' / ' + quiz.questionsMC.size() + ' MC / ' + quiz.questionsTF.size() + ' TF / ' + quiz.authorErrors.size() + ' errors'}"></span>
</div>
<!-- for each quiz -->
<div th:each="quiz : ${quizzes}">


<b>Multiple choice questions  - file: <span th:text="${quiz.sourceFile}"></span></b>
<table class="styled-table">
    <thead>
    <tr>
        <th>Id</th>
        <th>Chapter</th>
        <th>Row</th>
        <th>Title</th>
        <th>Text</th>
        <th>Response 1</th>
        <th>Response 2</th>
        <th>Response 3</th>
        <th>Response 4</th>
        <th>Weight Response 1</th>
        <th>Weight Response 2</th>
        <th>Weight Response 3</th>
        <th>Weight Response 4</th>
        <th>Author Name</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="questionDto : ${quiz.questionsMC}" class="data-row">
        <td th:text="${questionDto.id}"></td>
        <td th:text="${questionDto.chapter}"></td>
        <td th:text="${questionDto.row}"></td>
        <td th:text="${questionDto.title}"></td>
        <td th:text="${questionDto.text}"></td>
        <td th:text="${questionDto.response1}"></td>
        <td th:text="${questionDto.response2}"></td>
        <td th:text="${questionDto.response3}"></td>
        <td th:text="${questionDto.response4}"></td>
        <td th:text="${questionDto.weightResponse1}"></td>
        <td th:text="${questionDto.weightResponse2}"></td>
        <td th:text="${questionDto.weightResponse3}"></td>
        <td th:text="${questionDto.weightResponse4}"></td>
        <td th:text="${questionDto.authorName}"></td>
        <td class="action-cell">
            <a th:href="@{'/question-editor/' + ${questionDto.id}}" class="btn btn-edit">Edit</a>
            <button th:onclick="|deleteQuestion(${questionDto.id})|" class="btn btn-delete">Delete</button>
        </td>
    </tr>
    <tr th:if="${#lists.isEmpty(quiz.questionsMC)}" class="empty-row">
        <td colspan="15">No multi choice questions</td>
    </tr>
    </tbody>
</table>
<br>
<b>True/False Questions - <span th:text="${quiz.sourceFile}"></span> </b>
<table class="styled-table">
    <thead>
    <tr>
        <th>Id</th>
        <th>Chapter</th>
        <th>Title</th>
        <th>Row</th>
        <th>Text</th>
        <th>Weight TRUE</th>
        <th>Weight FALSE</th>
        <th>Response</th>
        <th>Author Name</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="questionDto : ${quiz.questionsTF}" class="data-row">
        <td th:text="${questionDto.id}"></td>
        <td th:text="${questionDto.chapter}"></td>
        <td th:text="${questionDto.title}"></td>
        <td th:text="${questionDto.row}"></td>
        <td th:text="${questionDto.text}"></td>
        <td th:text="${questionDto.weightTrue}"></td>
        <td th:text="${questionDto.weightFalse}"></td>
        <td th:text="${questionDto.response1}"></td>
        <td th:text="${questionDto.authorName}"></td>
        <td class="action-cell">
            <a th:href="@{'/question-editor/' + ${questionDto.id}}" class="btn btn-edit">Edit</a>
            <button th:onclick="|deleteQuestion(${questionDto.id})|" class="btn btn-delete">Delete</button>
        </td>
    </tr>
    <tr th:if="${#lists.isEmpty(quiz.questionsTF)}" class="empty-row">
        <td colspan="10">No true false questions</td>
    </tr>
    </tbody>
</table>
    <table class="styled-table">
        <thead>
        <tr>
            <th>Id</th>
            <th>Row</th>
            <th>Description</th>
            <th>Author</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="err : ${quiz.authorErrors}" class="data-row">
            <td th:text="${err.id}"></td>
            <td th:text="${err.row}"></td>
            <td th:text="${err.description}"></td>
            <td th:text="${err.authorName}"></td>
        </tr>
        <tr th:if="${#lists.isEmpty(quiz.authorErrors)}" class="empty-row">
            <td colspan="4">No errors</td>
        </tr>
        </tbody>
    </table>
</div>

<script>
function deleteQuestion(questionId) {
    if (confirm('Are you sure you want to delete this question? This action cannot be undone.')) {
        fetch('/api/question/' + questionId, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                alert('Question deleted successfully!');
                location.reload(); // Reload the page to reflect changes
            } else {
                return response.text().then(text => {
                    throw new Error(text || 'Unknown error occurred');
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting question: ' + error.message);
        });
    }
}

function filterQuestionsByAuthor() {
    var selectedAuthor = document.getElementById('authorFilter').value;
    // MC Questions: 14th column
    document.querySelectorAll('table.styled-table tbody tr.data-row').forEach(function(row) {
        var authorCell = row.querySelector('td:nth-child(14)');
        if (authorCell) {
            var authorName = authorCell.textContent.trim();
            row.style.display = (selectedAuthor === '' || authorName === selectedAuthor) ? '' : 'none';
            return;
        }
        // TF Questions: 9th column
        authorCell = row.querySelector('td:nth-child(9)');
        if (authorCell) {
            var authorName = authorCell.textContent.trim();
            row.style.display = (selectedAuthor === '' || authorName === selectedAuthor) ? '' : 'none';
            return;
        }
        // Error table: 4th column
        authorCell = row.querySelector('td:nth-child(4)');
        if (authorCell) {
            var authorName = authorCell.textContent.trim();
            row.style.display = (selectedAuthor === '' || authorName === selectedAuthor) ? '' : 'none';
            return;
        }
    });
}
</script>

</body>
</html>