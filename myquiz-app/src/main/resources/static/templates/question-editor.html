<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Question Editor</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/styles.css}">
    <style>
        .question-type-tabs {
            width: 100%;
            display: flex;
            margin-bottom: 20px;
        }
        .question-type-tabs .tab {
            flex: 1;
            text-align: center;
            padding: 16px 0;
            font-size: 1.2em;
            cursor: pointer;
            border: none;
            background: #f0f0f0;
            transition: background 0.2s;
        }
        .question-type-tabs .tab.active {
            background: #d0eaff;
            font-weight: bold;
        }
        .question-type-tabs .tab:not(:last-child) {
            border-right: 1px solid #ccc;
        }
        .editor-container {
            width: 100%;
            display: flex;
            gap: 32px;
            box-sizing: border-box;
        }
        .form-section, .json-section {
            flex: 1;
            min-width: 0;
            box-sizing: border-box;
        }
        .form-section {
            padding-right: 16px;
        }
        .json-section {
            padding-left: 16px;
        }
        @media (max-width: 900px) {
            .editor-container {
                flex-direction: column;
                gap: 0;
            }
            .form-section, .json-section {
                padding: 0;
            }
        }
    </style>
</head>
<body>

<div th:insert="~{fragments::menu}"></div>
<div style="clear:both; margin-bottom:20px;"></div>

<div class="container">
    <h2>üîß Question Editor</h2>

    <!-- Success/Error Messages -->
    <div th:if="${successMessage}" class="success-message" th:text="${successMessage}"></div>
    <div th:if="${errorMessage}" class="error-message" th:text="${errorMessage}"></div>

    <!-- Question Type Tabs -->
    <div class="question-type-tabs">
        <button class="tab active" onclick="showTab('mc')">Multiple Choice</button>
        <button class="tab" onclick="showTab('tf')">True/False</button>
    </div>

    <div class="editor-container">
        <!-- Form Section -->
        <div class="form-section">
            <h3>Edit Question</h3>

            <!-- Multiple Choice Form -->
            <div id="mc-content" class="tab-content active">
                <form th:action="@{/question-editor/save}" method="post" th:object="${question}">
                    <input type="hidden" th:field="*{id}" />
                    <input type="hidden" name="questionType" value="MC" />

                    <div class="form-group">
                        <label for="title">Question Title:</label>
                        <input type="text" id="title" th:field="*{title}" placeholder="Enter question title" />
                    </div>

                    <div class="form-group">
                        <label for="text">Question Text:</label>
                        <textarea id="text" th:field="*{text}" placeholder="Enter question text"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="chapter">Chapter:</label>
                        <input type="text" id="chapter" th:field="*{chapter}" placeholder="Chapter number or name" />
                    </div>

                    <div class="form-group">
                        <label for="authorName">Author Name:</label>
                        <input type="text" id="authorName" th:field="*{authorName}" placeholder="Author name" />
                    </div>

                    <div class="form-group">
                        <label>Response Options & Weights:</label>
                        <table style="width:100%; border-collapse:collapse;">
                            <tr>
                                <th style="text-align:left; padding:4px;">Answer</th>
                                <th style="text-align:left; padding:4px;">Weight</th>
                            </tr>
                            <tr>
                                <td style="padding:4px;"><input type="text" th:field="*{response1}" placeholder="Response 1" /></td>
                                <td style="padding:4px;">
                                    <select id="weightResponse1" th:field="*{weightResponse1}" required>
                                      <option value="-100.0">-100.0</option>
                                      <option value="-50.0">-50.0</option>
                                      <option value="0.0">0.0</option>
                                      <option value="25.0">25.0</option>
                                      <option value="33.33333">33.33333</option>
                                      <option value="50.0">50.0</option>
                                      <option value="100.0">100.0</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding:4px;"><input type="text" th:field="*{response2}" placeholder="Response 2" /></td>
                                <td style="padding:4px;">
                                    <select id="weightResponse2" th:field="*{weightResponse2}" required>
                                      <option value="-100.0">-100.0</option>
                                      <option value="-50.0">-50.0</option>
                                      <option value="0.0">0.0</option>
                                      <option value="25.0">25.0</option>
                                      <option value="33.33333">33.33333</option>
                                      <option value="50.0">50.0</option>
                                      <option value="100.0">100.0</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding:4px;"><input type="text" th:field="*{response3}" placeholder="Response 3" /></td>
                                <td style="padding:4px;">
                                    <select id="weightResponse3" th:field="*{weightResponse3}" required>
                                      <option value="-100.0">-100.0</option>
                                      <option value="-50.0">-50.0</option>
                                      <option value="0.0">0.0</option>
                                      <option value="25.0">25.0</option>
                                      <option value="33.33333">33.33333</option>
                                      <option value="50.0">50.0</option>
                                      <option value="100.0">100.0</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding:4px;"><input type="text" th:field="*{response4}" placeholder="Response 4" /></td>
                                <td style="padding:4px;">
                                    <select id="weightResponse4" th:field="*{weightResponse4}" required>
                                      <option value="-100.0">-100.0</option>
                                      <option value="-50.0">-50.0</option>
                                      <option value="0.0">0.0</option>
                                      <option value="25.0">25.0</option>
                                      <option value="33.33333">33.33333</option>
                                      <option value="50.0">50.0</option>
                                      <option value="100.0">100.0</option>
                                    </select>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-save">üíæ Save Question</button>
                        <button type="button" class="btn btn-new" onclick="newQuestion()">üìÑ New Question</button>
                        <button type="button" class="btn btn-delete" onclick="deleteQuestion()" th:if="${question.id != null}">üóëÔ∏è Delete</button>
                        <a th:href="@{/quiz/}" class="btn btn-cancel">‚ùå Cancel</a>
                    </div>
                </form>
            </div>

            <!-- True/False Form -->
            <div id="tf-content" class="tab-content">
                <form th:action="@{/question-editor/save}" method="post" th:object="${question}">
                    <input type="hidden" th:field="*{id}" />
                    <input type="hidden" name="questionType" value="TF" />

                    <div class="form-group">
                        <label for="tf-title">Question Title:</label>
                        <input type="text" id="tf-title" th:field="*{title}" placeholder="Enter question title" />
                    </div>

                    <div class="form-group">
                        <label for="tf-text">Question Text:</label>
                        <textarea id="tf-text" th:field="*{text}" placeholder="Enter question text"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="tf-chapter">Chapter:</label>
                        <input type="text" id="tf-chapter" th:field="*{chapter}" placeholder="Chapter number or name" />
                    </div>

                    <div class="form-group">
                        <label for="tf-authorName">Author Name:</label>
                        <input type="text" id="tf-authorName" th:field="*{authorName}" placeholder="Author name" />
                    </div>

                    <div class="form-group">
                        <label>True/False Weights (supports negative values):</label>
                        <div class="weight-inputs">
                            <input type="number" th:field="*{weightTrue}" placeholder="Weight for True (e.g., 100, -100)" step="any" />
                            <input type="number" th:field="*{weightFalse}" placeholder="Weight for False (e.g., 0, -100)" step="any" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="tf-response">Correct Answer:</label>
                        <select id="tf-response" th:field="*{response1}">
                            <option value="">Select correct answer</option>
                            <option value="True">True</option>
                            <option value="False">False</option>
                        </select>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-save">üíæ Save Question</button>
                        <button type="button" class="btn btn-new" onclick="newQuestion()">üìÑ New Question</button>
                        <button type="button" class="btn btn-delete" onclick="deleteQuestion()" th:if="${question.id != null}">üóëÔ∏è Delete</button>
                        <a th:href="@{/quiz/}" class="btn btn-cancel">‚ùå Cancel</a>
                    </div>
                </form>
            </div>
        </div>

        <!-- JSON Display Section -->
        <div class="json-section">
            <h3>üìÑ Question JSON</h3>
            <div class="json-display" id="jsonDisplay">
                <span th:utext="${questionJson}">
                {
                  "id": null,
                  "title": "Sample Question",
                  "text": "What is the capital of France?",
                  "chapter": "Geography",
                  "authorName": "Sample Author",
                  "response1": "Paris",
                  "response2": "London",
                  "response3": "Berlin",
                  "response4": "Madrid",
                  "weightResponse1": 100,
                  "weightResponse2": 0,
                  "weightResponse3": 0,
                  "weightResponse4": 0,
                  "questionType": "MC"
                }
                </span>
            </div>

            <div style="margin-top: 20px;">
                <h4>üîß Quick Actions</h4>
                <button class="btn btn-new" onclick="loadSampleQuestion('MC')" style="margin: 5px;">Load MC Sample</button>
                <button class="btn btn-new" onclick="loadSampleQuestion('TF')" style="margin: 5px;">Load TF Sample</button>
                <button class="btn btn-save" onclick="copyJsonToClipboard()" style="margin: 5px;">üìã Copy JSON</button>
            </div>
        </div>
    </div>
</div>

<script>
    function showTab(type) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });

        // Remove active class from all tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });

        // Show selected tab content
        document.getElementById(type + '-content').classList.add('active');

        // Add active class to selected tab
        event.target.classList.add('active');

        updateJsonDisplay();
    }

    function updateJsonDisplay() {
        const activeTab = document.querySelector('.tab-content.active');
        const form = activeTab.querySelector('form');
        const formData = new FormData(form);

        const questionData = {};
        for (let [key, value] of formData.entries()) {
            if (key !== 'questionType') {
                questionData[key] = value || null;
            }
        }

        const questionType = formData.get('questionType');
        questionData.questionType = questionType;

        if (questionType === 'TF') {
            // For True/False questions, set unused fields to null
            questionData.response2 = null;
            questionData.response3 = null;
            questionData.response4 = null;
            questionData.weightResponse2 = null;
            questionData.weightResponse3 = null;
            questionData.weightResponse4 = null;
        }

        document.getElementById('jsonDisplay').textContent = JSON.stringify(questionData, null, 2);
    }

    function newQuestion() {
        window.location.href = '/question-editor';
    }

    function deleteQuestion() {
        if (confirm('Are you sure you want to delete this question? This action cannot be undone.')) {
            const questionId = document.querySelector('input[name="id"]').value;
            if (questionId) {
                window.location.href = '/question-editor/delete/' + questionId;
            }
        }
    }

    function loadSampleQuestion(type) {
        if (type === 'MC') {
            document.getElementById('title').value = 'Sample Multiple Choice Question';
            document.getElementById('text').value = 'What is the capital of France?';
            document.getElementById('chapter').value = 'Geography';
            document.getElementById('authorName').value = 'Sample Author';
            document.querySelector('input[name="response1"]').value = 'Paris';
            document.querySelector('input[name="response2"]').value = 'London';
            document.querySelector('input[name="response3"]').value = 'Berlin';
            document.querySelector('input[name="response4"]').value = 'Madrid';
            document.querySelector('input[name="weightResponse1"]').value = '100';
            document.querySelector('input[name="weightResponse2"]').value = '0';
            document.querySelector('input[name="weightResponse3"]').value = '0';
            document.querySelector('input[name="weightResponse4"]').value = '0';
            showTab('mc');
        } else {
            document.getElementById('tf-title').value = 'Sample True/False Question';
            document.getElementById('tf-text').value = 'The Earth is round.';
            document.getElementById('tf-chapter').value = 'Science';
            document.getElementById('tf-authorName').value = 'Sample Author';
            document.querySelector('input[name="weightTrue"]').value = '100';
            document.querySelector('input[name="weightFalse"]').value = '0';
            document.querySelector('select[name="response1"]').value = 'True';
            showTab('tf');
        }
        updateJsonDisplay();
    }

    function copyJsonToClipboard() {
        const jsonText = document.getElementById('jsonDisplay').textContent;
        navigator.clipboard.writeText(jsonText).then(() => {
            alert('JSON copied to clipboard!');
        });
    }

    // Update JSON display when form fields change
    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
            input.addEventListener('input', updateJsonDisplay);
            input.addEventListener('change', updateJsonDisplay);
        });

        // Initial JSON display update
        updateJsonDisplay();
    });

    // Weight validation for MC form
    document.addEventListener('DOMContentLoaded', function() {
        var mcForm = document.querySelector('#mc-content form');
        if (mcForm) {
            mcForm.addEventListener('submit', function(e) {
                const w = [
                    parseFloat(document.getElementById('weightResponse1').value),
                    parseFloat(document.getElementById('weightResponse2').value),
                    parseFloat(document.getElementById('weightResponse3').value),
                    parseFloat(document.getElementById('weightResponse4').value)
                ];
                // Rule 1: If any is 25.0, all must be 25.0
                if (w.includes(25.0) && !w.every(val => val === 25.0)) {
                    alert('If one weight is 25.0, all must be 25.0');
                    e.preventDefault();
                    return;
                }
                // Rule 2: If any is 33.33333, sum must be 100.0 or less than 0.0
                if (w.includes(33.33333)) {
                    const sum = w.reduce((a, b) => a + b, 0);
                    if (sum !== 100.0 && sum >= 0.0) {
                        alert('If one weight is 33.33333, the sum must be 100.0 or less than 0.0');
                        e.preventDefault();
                        return;
                    }
                }
                // Rule 3: If any is 50.0, others must be [50.0, -50.0, -50.0] in any order
                if (w.includes(50.0)) {
                    const sorted = w.slice().sort((a, b) => a - b);
                    const valid = JSON.stringify(sorted) === JSON.stringify([-50.0, -50.0, 50.0, 50.0]);
                    if (!valid) {
                        alert('If one weight is 50.0, the others must be 50.0, -50.0, -50.0');
                        e.preventDefault();
                        return;
                    }
                }
                // Rule 4: If any is 100.0, all others must be -100.0
                if (w.includes(100.0)) {
                    const others = w.filter(val => val !== 100.0);
                    if (!others.every(val => val === -100.0)) {
                        alert('If one weight is 100.0, all others must be -100.0');
                        e.preventDefault();
                        return;
                    }
                }
            });
        }
    });
</script>

</body>
</html>
