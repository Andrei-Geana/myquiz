<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="ISO-8859-1">
    <title>Errors List</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/styles.css}">
</head>
<body>

<div th:insert="~{fragments::menu}"></div>
<div style="clear:both; margin-bottom:20px;"></div>

<!-- Filter section -->
<div class="searchfilters">
    <form method="get" action="/errors/">
        <label for="courseFilter">Filter by Course:</label>
        <select id="courseFilter" name="selectedCourse" onchange="this.form.submit()">
            <option value="">All Courses</option>
            <option th:each="course : ${courses}"
                    th:value="${course}"
                    th:text="${course}"
                    th:selected="${course} == ${selectedCourse}"></option>
        </select>

        <label for="authorFilter">Filter by Author:</label>
        <select id="authorFilter" name="selectedAuthor">
            <option value="">All Authors</option>
            <option th:each="author : ${authors}"
                    th:value="${author}"
                    th:text="${author}"
                    th:selected="${author} == ${selectedAuthor}"></option>
        </select>
        <button type="submit">Filter</button>
    </form>
</div>

<table class="styled-table">
    <thead>
    <tr>
        <th>Id</th>
        <th>Quiz Name</th>
        <th>Row Number</th>
        <th>Error Description</th>
        <th>Author Name</th>
        <th>Date Created</th>
        <th>Status</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="error : ${errors}" class="data-row" th:data-author="${error.authorName}">
        <td th:text="${error.id}"></td>
        <td th:text="${error.quizName}"></td>
        <td th:text="${error.row}"></td>
        <td th:text="${error.description}"></td>
        <td th:text="${error.authorName}"></td>
        <td th:text="${#dates.format(error.dateCreated, 'yyyy-MM-dd HH:mm')}"></td>
        <td th:text="${error.status}"></td>
        <td class="action-cell">
            <a th:if="${error.questionId != null}" th:href="@{'/question-editor/' + ${error.questionId}}" class="btn btn-edit">View Question</a>
            <span th:if="${error.questionId == null}" class="btn btn-disabled">No Question</span>
            <button th:onclick="|markAsResolved(${error.id})|" class="btn btn-add" th:if="${error.status != 'RESOLVED'}">Mark Resolved</button>
            <button th:onclick="|deleteError(${error.id})|" class="btn btn-delete">Delete</button>
        </td>
    </tr>
    <tr th:if="${#lists.isEmpty(errors)}" class="empty-row">
        <td colspan="8">No errors found</td>
    </tr>
    </tbody>
</table>

<script>
function deleteError(errorId) {
    if (confirm('Are you sure you want to delete this error record? This action cannot be undone.')) {
        fetch('/api/error/' + errorId, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                alert('Error deleted successfully!');
                location.reload();
            } else {
                return response.text().then(text => {
                    throw new Error(text || 'Unknown error occurred');
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting error record: ' + error.message);
        });
    }
}

function markAsResolved(errorId) {
    if (confirm('Mark this error as resolved?')) {
        fetch('/api/error/' + errorId + '/resolve', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                alert('Error marked as resolved!');
                location.reload();
            } else {
                return response.text().then(text => {
                    throw new Error(text || 'Unknown error occurred');
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating status: ' + error.message);
        });
    }
}
</script>

</body>
</html>
