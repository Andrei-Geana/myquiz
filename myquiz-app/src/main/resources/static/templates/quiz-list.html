<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="ISO-8859-1">
    <title>Quizzes List</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/styles.css}">
</head>
<body>

<div th:insert="~{fragments::menu}"></div>
<div style="clear:both; margin-bottom:20px;"></div>

<div class="quizfilter">
    <label for="courseFilter">Filter by Course:</label>
    <select id="courseFilter" onchange="filterQuizzes()">
        <option value="">All Courses</option>
        <option th:each="quiz : ${quizzes}" th:value="${quiz.course}" th:text="${quiz.course}" th:if="${quiz.course != null and quiz.course != ''}"></option>
    </select>
</div>

<table class="styled-table">
    <thead>
    <tr>
        <th>Id</th>
        <th>Quiz Name</th>
        <th>Course</th>
        <th>Year</th>
        <th>MC Questions</th>
        <th>TF Questions</th>
        <th>Total Questions</th>
        <th>Authors</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="quiz : ${quizzes}" class="data-row" th:data-course="${quiz.course}">
        <td th:text="${quiz.id}"></td>
        <td th:text="${quiz.name}"></td>
        <td th:text="${quiz.course}"></td>
        <td th:text="${quiz.year}"></td>
        <td th:text="${quiz.mcQuestionsCount}"></td>
        <td th:text="${quiz.tfQuestionsCount}"></td>
        <td th:text="${quiz.mcQuestionsCount + quiz.tfQuestionsCount}"></td>
        <td th:text="${quiz.noAuthors}"></td>
        <td class="action-cell">
            <a href="#" class="btn btn-edit"
               th:attr="data-course=${quiz.course},data-quizid=${quiz.id}"
               onclick="setSelectedCourseAndViewFromElement(this)">View</a>
            <a th:href="@{'/quiz/edit/' + ${quiz.id}}" class="btn btn-edit">Edit</a>
            <button th:onclick="|deleteQuiz(${quiz.id})|" class="btn btn-delete">Delete</button>
            <a th:href="@{'/quiz/' + ${quiz.id} + '/export-mc'}" class="btn btn-export" target="_blank">CSV MC</a>
            <a th:href="@{'/quiz/' + ${quiz.id} + '/export-tf'}" class="btn btn-export" target="_blank">CSV TF</a>
        </td>
    </tr>
    <tr th:if="${#lists.isEmpty(quizzes)}" class="empty-row">
        <td colspan="10">No quizzes found</td>
    </tr>
    </tbody>
</table>

<script>
function deleteQuiz(quizId) {
    if (confirm('Are you sure you want to delete this quiz? This will also delete all associated questions. This action cannot be undone.')) {
        fetch('/quiz/' + quizId + '/delete', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                alert('Quiz deleted successfully!');
                location.reload();
            } else {
                return response.text().then(text => {
                    throw new Error(text || 'Unknown error occurred');
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting quiz: ' + error.message);
        });
    }
}

function filterQuizzes() {
    const courseFilter = document.getElementById('courseFilter').value;
    const rows = document.querySelectorAll('tbody tr.data-row');

    rows.forEach(row => {
        const course = row.getAttribute('data-course');
        if (courseFilter === '' || course === courseFilter) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function setSelectedCourseAndView(course, quizId) {
    fetch('/api/session/course', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'course=' + encodeURIComponent(course)
    }).then(function() {
        window.location.href = '/quiz/' + quizId;
    });
}

function setSelectedCourseAndViewFromElement(el) {
    const course = el.dataset.course;
    const quizId = el.dataset.quizid;
    setSelectedCourseAndView(course, quizId);
}

function exportQuizToExcel(quizId) {
    window.location.href = '/quiz/' + quizId + '/export';
}
</script>

</body>
</html>
